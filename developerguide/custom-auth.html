<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="AWSDocsDocPageApp">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Connecting to AWS IoT Core by using custom authentication - AWS IoT Core</title>
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <meta name="assets_root" content="assets" />
      <meta name="target_state" content="custom-auth" />
      <meta name="default_state" content="custom-auth" />
      <link rel="icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="canonical" href="https://docs.aws.amazon.com/iot/latest/developerguide/custom-auth.html" />
      <meta name="description" content="Devices can connect to AWS IoT Core by using custom authentication with any protocol that AWS IoT Core supports for device messaging. For more information about supported communication protocols, see .  The connection data that you pass to your authorizer Lambda function depends on the protocol you use. For more information about creating your authorizer Lambda function, see" />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="AWS IoT Core" />
      <meta name="guide" content="Developer Guide" />
      <meta name="locales" content="de_de:Deutsch/en_us:English/es_es:Español/fr_fr:Français/it_it:Italiano/ja_jp:日本語/ko_kr:한국어/pt_br:Português/zh_cn:中文 (简体)/zh_tw:中文 (繁體)" />
      <meta name="abstract" content="AWS IoT provides secure, bi-directional communication between Internet-connected devices such as sensors, actuators, embedded micro-controllers, or smart appliances and the AWS Cloud. This enables you to collect telemetry data from multiple devices, and store and analyze the data. You can also create applications that enable your users to control these devices from their phones or tablets." />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <meta name="feedback-item" content="IoT Docs" />
      <meta name="this_doc_product" content="AWS IoT Core" />
      <meta name="this_doc_guide" content="Developer Guide" />
      <link href="assets/css/vendor4.css" rel="stylesheet" />
      <link href="assets/css/awsdocs-common.css" rel="stylesheet" /><script type="text/javascript" src="assets/js/vendor3.js" defer=""></script><script type="text/javascript" src="assets/js/vendor4.js" defer=""></script><script type="text/javascript" src="assets/js/vendor1.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-common.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-doc-app.js" defer=""></script></head>
   <body class="awsdocs awsui">
      <div class="awsdocs-container">
         <awsdocs-header></awsdocs-header>
         <awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)">
            <div id="guide-toc" dom-region="navigation">
               <awsdocs-toc></awsdocs-toc>
            </div>
            <div id="main-column" dom-region="content" tabindex="-1">
               <awsdocs-view class="awsdocs-view">
                  <div id="awsdocs-content">
                     <head>
                        <title>Connecting to AWS IoT Core by using custom authentication - AWS IoT Core</title>
                        <meta name="pdf" content="iot-dg.pdf#custom-auth" />
                        <meta name="kindle" content="https://www.amazon.com/dp/B07JBRCWWZ" />
                        <meta name="github" content="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/custom-auth.md" />
                        <meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=210" />
                        <meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT%20Docs&amp;topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/custom-auth.html" />
                        <meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/custom-auth.html" />
                        <meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/custom-auth.html" />
                        <meta name="keywords" content="AWS IoT,IoT,Internet of Things" />
                     </head>
                     <body>
                        <div id="main">
                           <div style="display: none"><a href="iot-dg.pdf#custom-auth" target="_blank" rel="noopener noreferrer" title="Open PDF"></a><a target="_blank" rel="noopener noreferrer" href="https://www.amazon.com/dp/B07JBRCWWZ" title="Open Kindle"></a><a href="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/custom-auth.md" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub"></a></div>
                           <div id="breadcrumbs" class="breadcrumb"><a href="http://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/iot/index.html">AWS IoT Core</a><a href="what-is-aws-iot.html">Developer Guide</a></div>
                           <div id="page-toc-src"><a href="#custom-auth-http">HTTP</a><a href="#custom-auth-mqtt">MQTT</a><a href="#custom-auth-websockets">MQTT over WebSockets</a><a href="#custom-auth-token-signature">Signing the token</a></div>
                           <div id="main-content" class="awsui-util-container">
                              <div id="main-col-body">
                                 <awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner>
                                 <h1 class="topictitle" id="custom-auth">Connecting to AWS IoT Core by using custom authentication</h1>
                                 <div class="awsdocs-page-header-container">
                                    <awsdocs-page-header></awsdocs-page-header>
                                    <awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector>
                                 </div>
                                 <p>
                                    Devices can connect to AWS IoT Core by using custom authentication with
                                    any protocol 
                                    that AWS IoT Core supports for device messaging. For more information about supported
                                    communication protocols, see <a href="./protocols.html">Device communication protocols</a>. 
                                    The connection data that you pass to your authorizer Lambda function depends on the
                                    protocol you use. For more information about creating your authorizer Lambda function,
                                    see <a href="./config-custom-auth.html#custom-auth-lambda">Defining your Lambda function</a>. 
                                    The following sections explain how to connect to authenticate by using each supported
                                    protocol.
                                    
                                 </p>
                                 
                                 <h2 id="custom-auth-http">HTTP</h2>
                                 
                                 <p>
                                    Devices sending data to AWS IoT Core by using the
                                    <a href="https://docs.aws.amazon.com/iot/latest/apireference/API_iotdata_Publish.html">HTTP
                                       Publish API</a> can pass credentials either through request headers or query 
                                    parameters in their HTTP POST requests. Devices can specify an
                                    authorizer to invoke by using the
                                    <code class="code">x-amz-customauthorizer-name</code> header or query
                                    parameter. If you have token signing enabled in your authorizer, you
                                    must pass the <code class="code">token-key-name</code> and
                                    <code class="code">x-amz-customauthorizer-signature</code> in either request headers or query
                                    parameters. The following example requests show how you pass these parameters in both
                                    request 
                                    headers and query parameters.
                                    
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">
//Passing credentials via headers
POST /topics/topic?qos=qos HTTP/1.1
Host: your-endpoint 
x-amz-customauthorizer-signature: token-signature
token-key-name: some-token 
x-amz-customauthorizer-name: &lt;authorizer-name&gt;

//Passing credentials via query parameters
POST /topics/topic?qos=qos&amp;x-amz-customauthorizer-signature=$<span>{</span>sign}&amp;token-name=$<span>{</span>token-value} HTTP/1.1
</code></pre>
                                  
                                 <h2 id="custom-auth-mqtt">MQTT</h2>
                                 
                                 <p> Devices connecting to AWS IoT Core by using an MQTT connection can pass credentials
                                    through the <code class="code">username</code> and <code class="code">password</code> fields of MQTT
                                    messages. The <code class="code">username</code> value can also optionally contain a query
                                    string that passes additional values (including a token, signature, and
                                    authorizer name) to your authorizer.  You can use this query string if you want
                                    to use a token-based authentication scheme instead of <code class="code">username</code> and
                                    <code class="code">password</code> values.  
                                 </p>
                                 
                                 <div class="awsdocs-note">
                                    <div class="awsdocs-note-title">
                                       <awsui-icon name="status-info" variant="link"></awsui-icon><span>Note</span></div>
                                    <div class="awsdocs-note-text">
                                       <p>
                                          Data in the password field is base64-encoded by AWS IoT Core. Your 
                                          Lambda function must decode it.
                                          
                                       </p>
                                    </div>
                                 </div>
                                 
                                 <p>
                                    The following example contains a <code class="code">username</code> string that contains 
                                    extra parameters that specify a token and signature. 
                                    
                                 </p>
                                 
                                 <p>
                                    <code class="code">username?x-amz-customauthorizer-name=$<span>{</span>name}&amp;x-amz-customauthorizer-signature=$<span>{</span>sign}&amp;token-name=$<span>{</span>token-value}</code>
                                    
                                 </p>
                                 
                                 <p>
                                    In order to invoke an authorizer, devices connecting to AWS IoT Core by using MQTT
                                    and custom authentication
                                    must connect on port 443. They also must pass the Application Layer Protocol
                                    Negotiation (ALPN) TLS extension with a value of <code class="code">mqtt</code> and the
                                    Server Name Indication (SNI) extension with the host name of their AWS IoT Core 
                                    data endpoint. For more information about these values, see 
                                    <a href="./protocols.html">Device communication protocols</a>. 
                                    The V2 <a href="./iot-sdks.html">AWS IoT Device SDKs, Mobile SDKs, and AWS IoT Device Client</a> can configure both of these
                                    extensions.   
                                    
                                 </p>
                                  
                                 
                                 <h2 id="custom-auth-websockets">MQTT over WebSockets</h2>
                                 
                                 <p> Devices connecting to AWS IoT Core by using MQTT over WebSockets can pass
                                    credentials in one of the two following ways. 
                                 </p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          <p>Through request headers or query parameters in the 
                                             HTTP UPGRADE request to establish the WebSockets connection.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          <p>Through the <code class="code">username</code> and <code class="code">password</code> fields in the MQTT CONNECT message.
                                          </p>
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 <p> If you pass credentials through the MQTT connect message, the ALPN and SNI
                                    TLS extensions are required. For more information about these extensions, see
                                    <a href="#custom-auth-mqtt">MQTT</a>.   The following example demonstrates how
                                    to pass credentials through the HTTP Upgrade request. 
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">
GET /mqtt HTTP/1.1
 Host: your-endpoint 
Upgrade: WebSocket 
Connection: Upgrades 
x-amz-customauthorizer-signature: token-signature
token-key-name: some-token 
sec-WebSocket-Key: any random base64 value 
sec-websocket-protocol: mqtt 
sec-WebSocket-Version: websocket version
</code></pre>
                                  
                                 <h2 id="custom-auth-token-signature">Signing the token</h2>
                                 
                                 <p>You must sign the token with the private key of the public-private key pair that you
                                    used in the <code class="code">create-authorizer</code> call. 
                                    The following examples show how to create the token signature by using a UNIX-like
                                    command and JavaScript. They use the SHA-256 hash algorithm to encode the signature.
                                 </p>
                                 
                                 <awsdocs-tabs>
                                    <dl style="display: none">
                                       
                                       <dt>Command line</dt>
                                       <dd tab-id="command-line">
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">echo -n <code class="replaceable">TOKEN_VALUE</code> | openssl dgst -sha256 -sign <code class="replaceable">PEM encoded RSA private key</code> | openssl base64</code></pre>
                                          </dd>
                                       
                                       <dt>JavaScript</dt>
                                       <dd tab-id="javascript">
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="javascript ">
const crypto = require('crypto')

const key = "<code class="replaceable">PEM encoded RSA private key</code>"

const k = crypto.createPrivateKey(key)
let sign = crypto.createSign('SHA256')
sign.write(t)
sign.end()
const s = sign.sign(k, 'base64')                                                              
                            </code></pre>
                                          </dd> 
                                       
                                    </dl>
                                 </awsdocs-tabs>
                                 
                                 <awsdocs-copyright class="copyright-print"></awsdocs-copyright>
                                 <awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback>
                              </div>
                              <noscript>
                                 <div>
                                    <div>
                                       <div>
                                          <div id="js_error_message">
                                             <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your
                                                   browser.</strong></p>
                                             <p>To use the Amazon Web Services Documentation, Javascript must be
                                                enabled. Please refer to your browser's Help pages for instructions.
                                             </p>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </noscript>
                              <div id="main-col-footer" class="awsui-util-font-size-0">
                                 <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                                 <div class="prev-next">
                                    <div id="previous" class="prev-link" accesskey="p" href="./config-custom-auth.html">Creating and managing custom authorizers</div>
                                    <div id="next" class="next-link" accesskey="n" href="./custom-auth-troubleshooting.html">Troubleshooting your authorizers</div>
                                 </div>
                              </div>
                              <awsdocs-page-utilities></awsdocs-page-utilities>
                           </div>
                           <div id="quick-feedback-yes" style="display: none;">
                              <div class="title">Did this page help you? - Yes</div>
                              <div class="content">
                                 <p>Thanks for letting us know we're doing a good
                                    job!
                                 </p>
                                 <p>If you've got a moment, please tell us what we did right
                                    so we can do more of it.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/custom-auth.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                           <div id="quick-feedback-no" style="display: none;">
                              <div class="title">Did this page help you? - No</div>
                              <div class="content">
                                 <p>Thanks for letting us know this page needs work. We're
                                    sorry we let you down.
                                 </p>
                                 <p>If you've got a moment, please tell us how we can make
                                    the documentation better.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/custom-auth.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                        </div>
                     </body>
                  </div>
               </awsdocs-view>
               <div class="page-loading-indicator" id="page-loading-indicator">
                  <awsui-spinner size="large"></awsui-spinner>
               </div>
            </div>
            <div id="tools-panel" dom-region="tools">
               <awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel>
            </div>
         </awsui-app-layout>
         <awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner>
         <!--
                SiteCatalyst code version: H.25.2.
                Copyright 1996-2012 Adobe, Inc. All Rights Reserved
                More info available at http://www.omniture.com
            --><script language="JavaScript" type="text/javascript">
var awsdocs = awsdocs || {};
awsdocs.prop66 = 'AWS IoT Core';
awsdocs.prop65 =  'Developer Guide';
            </script><script src="https://a0.awsstatic.com/s_code/js/3.0/awshome_s_code.js" language="JavaScript" type="text/javascript"></script>
         <!--/DO NOT REMOVE/-->
         <!--End SiteCatalyst code version: H.25.2.--></div>
   </body>
</html>