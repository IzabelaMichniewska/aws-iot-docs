<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="AWSDocsDocPageApp">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Connect a device to AWS IoT Core by using the AWS IoT Device SDK - AWS IoT Core</title>
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <meta name="assets_root" content="assets" />
      <meta name="target_state" content="sdk-tutorials" />
      <meta name="default_state" content="sdk-tutorials" />
      <link rel="icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="canonical" href="https://docs.aws.amazon.com/iot/latest/developerguide/sdk-tutorials.html" />
      <meta name="description" content="Learn how to use the AWS IoT Device SDK to connect a device to AWS IoT Core." />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="AWS IoT Core" />
      <meta name="guide" content="Developer Guide" />
      <meta name="locales" content="de_de:Deutsch/en_us:English/es_es:Español/fr_fr:Français/it_it:Italiano/ja_jp:日本語/ko_kr:한국어/pt_br:Português/zh_cn:中文 (简体)/zh_tw:中文 (繁體)" />
      <meta name="abstract" content="AWS IoT provides secure, bi-directional communication between Internet-connected devices such as sensors, actuators, embedded micro-controllers, or smart appliances and the AWS Cloud. This enables you to collect telemetry data from multiple devices, and store and analyze the data. You can also create applications that enable your users to control these devices from their phones or tablets." />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <meta name="feedback-item" content="IoT Docs" />
      <meta name="this_doc_product" content="AWS IoT Core" />
      <meta name="this_doc_guide" content="Developer Guide" />
      <link href="assets/css/vendor4.css" rel="stylesheet" />
      <link href="assets/css/awsdocs-common.css" rel="stylesheet" /><script type="text/javascript" src="assets/js/vendor3.js" defer=""></script><script type="text/javascript" src="assets/js/vendor4.js" defer=""></script><script type="text/javascript" src="assets/js/vendor1.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-common.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-doc-app.js" defer=""></script></head>
   <body class="awsdocs awsui">
      <div class="awsdocs-container">
         <awsdocs-header></awsdocs-header>
         <awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)">
            <div id="guide-toc" dom-region="navigation">
               <awsdocs-toc></awsdocs-toc>
            </div>
            <div id="main-column" dom-region="content" tabindex="-1">
               <awsdocs-view class="awsdocs-view">
                  <div id="awsdocs-content">
                     <head>
                        <title>Connect a device to AWS IoT Core by using the AWS IoT Device SDK - AWS IoT Core</title>
                        <meta name="pdf" content="iot-dg.pdf#sdk-tutorials" />
                        <meta name="kindle" content="https://www.amazon.com/dp/B07JBRCWWZ" />
                        <meta name="github" content="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/sdk-tutorials.md" />
                        <meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=210" />
                        <meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT%20Docs&amp;topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/sdk-tutorials.html" />
                        <meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/sdk-tutorials.html" />
                        <meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/sdk-tutorials.html" />
                        <meta name="keywords" content="AWS IoT,IoT,Internet of Things" />
                     </head>
                     <body>
                        <div id="main">
                           <div style="display: none"><a href="iot-dg.pdf#sdk-tutorials" target="_blank" rel="noopener noreferrer" title="Open PDF"></a><a target="_blank" rel="noopener noreferrer" href="https://www.amazon.com/dp/B07JBRCWWZ" title="Open Kindle"></a><a href="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/sdk-tutorials.md" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub"></a></div>
                           <div id="breadcrumbs" class="breadcrumb"><a href="http://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/iot/index.html">AWS IoT Core</a><a href="what-is-aws-iot.html">Developer Guide</a></div>
                           <div id="page-toc-src"><a href="#sdk-tutorials-prepare">Prepare your device for AWS IoT</a><a href="#sdk-tutorials-mqtt-review">Review the MQTT protocol</a><a href="#sdk-tutorials-explore-sample">Review the pubsub.py Device SDK sample
                                 app</a><a href="#sdk-tutorials-experiment">Connect your device and communicate with AWS IoT Core</a><a href="#sdk-tutorials-conclusion">Review the results</a></div>
                           <div id="main-content" class="awsui-util-container">
                              <div id="main-col-body">
                                 <awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner>
                                 <h1 class="topictitle" id="sdk-tutorials">Connect a device to AWS IoT Core by using the AWS IoT Device SDK</h1>
                                 <div class="awsdocs-page-header-container">
                                    <awsdocs-page-header></awsdocs-page-header>
                                    <awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector>
                                 </div>
                                 <p>This tutorial demonstrates how to connect a device to AWS IoT Core so that it can
                                    send and receive 
                                    data to and from AWS IoT. After you complete this tutorial, your device will be configured
                                    to
                                    connect to AWS IoT Core and you'll understand how devices communicate with AWS IoT.
                                 </p>
                                 <p><b>In this tutorial, you’ll:</b></p>
                                 <div class="orderedlist">
                                     
                                     
                                     
                                     
                                     
                                    
                                    <ol>
                                       <li>
                                          <p><a href="#sdk-tutorials-prepare">Prepare your device for AWS IoT</a></p>
                                       </li>
                                       <li>
                                          <p><a href="#sdk-tutorials-mqtt-review">Review the MQTT protocol</a></p>
                                       </li>
                                       <li>
                                          <p><a href="#sdk-tutorials-explore-sample">Review the pubsub.py Device SDK sample
                                                app</a></p>
                                       </li>
                                       <li>
                                          <p><a href="#sdk-tutorials-experiment">Connect your device and communicate with AWS IoT Core</a></p>
                                       </li>
                                       <li>
                                          <p><a href="#sdk-tutorials-conclusion">Review the results</a></p>
                                       </li>
                                    </ol>
                                 </div>
                                 <p>This tutorial takes about an hour to complete.</p>
                                 <div class="itemizedlist">
                                    
                                    <p class="title"><b>Before you start this tutorial, make sure that you have:</b></p>
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                           
                                          
                                          <p class="title"><b>Completed <a href="./iot-gs.html">Getting started with AWS IoT Core</a></b></p>
                                          
                                          <p>In the section of that tutorial where you must <a href="./configure-device.html">Configure your device</a>,
                                             select the <a href="./connecting-to-existing-device.html">Connect a Raspberry
                                                Pi or another device</a> option for your device and use the 
                                             Python language options to configure your device.
                                          </p>
                                           
                                          
                                          <p>Be sure to keep open the terminal window you use in that tutorial because you'll also
                                             use it in this tutorial.
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                           
                                          
                                          <p class="title"><b>A device that can run the AWS IoT Device SDK v2 for Python. </b></p>
                                          
                                          <p>This tutorial shows how to connect a device to AWS IoT Core by using Python code examples,
                                             which
                                             require a relatively powerful device, as IoT and embedded devices go.
                                          </p>
                                           
                                          
                                          <p>If you are working with resource-constrained devices, these code examples might not
                                             work on them. In that case, you might have more success by <a href="./iot-embedded-c-sdk.html">Using the AWS IoT Device SDK for Embedded C</a> tutorial.
                                          </p>        
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 <h2 id="sdk-tutorials-prepare">Prepare your device for AWS IoT</h2>
                                 
                                 <p>In <a href="./iot-gs.html">Getting started with AWS IoT Core</a>, you prepared your device and AWS
                                    account so they could communicate. This section reviews the aspects of that preparation
                                    that apply to any device connection with AWS IoT Core.
                                 </p>
                                 
                                 <p>For a device to connect to AWS IoT Core:</p>
                                 
                                 <div class="orderedlist">
                                     
                                     
                                     
                                     
                                    
                                    <ol>
                                       <li>
                                          
                                          <p>You must have an <b>AWS account</b>.
                                          </p>
                                          
                                          <p>The procedure in 
                                             <a href="./setting-up.html">Set up your AWS account</a> describes
                                             how to create an AWS account if you don’t already have one.
                                             
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>In that account, you must have the following 
                                             <b>AWS IoT resources</b> defined for the 
                                             device in your AWS account and Region.
                                          </p>
                                          
                                          <p>The procedure in
                                             <a href="./create-iot-resources.html">Create AWS IoT resources</a>
                                             describes how to create these resources for the device in your AWS account
                                             and Region.
                                          </p>
                                          
                                          <div class="itemizedlist">
                                              
                                              
                                             
                                             <ul class="itemizedlist" type="disc">
                                                <li class="listitem">
                                                   
                                                   <p>A <b>device certificate</b> registered with
                                                      AWS IoT and activated to authenticate the device.
                                                   </p>
                                                   
                                                   <p>The certificate is often created with, and attached to, an <b>AWS IoT thing object</b>. While a thing object is
                                                      not required for a device to connect to AWS IoT, it makes additional
                                                      AWS IoT features available to the device.
                                                   </p>
                                                   
                                                </li>
                                                <li class="listitem">
                                                   
                                                   <p>A <b>policy</b> attached to the device
                                                      certificate that authorizes it to connect to AWS IoT Core and perform all the
                                                      actions that you want it to.
                                                   </p>
                                                   
                                                </li>
                                             </ul>
                                          </div>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>An <b>internet connection</b> that can access your
                                             AWS account’s device endpoints.
                                          </p>
                                          
                                          <p>The device endpoints are described in <a href="./iot-connect-devices.html#iot-connect-device-endpoints">AWS IoT device data and service
                                                endpoints</a> and can be seen in the 
                                             <a href="https://console.aws.amazon.com/iot/home#/settings" rel="noopener noreferrer" target="_blank"><span>settings page
                                                   of the AWS IoT console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                             
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p><b>Communication software</b> such as the AWS IoT
                                             Device SDKs provide. This tutorial uses the 
                                             <a href="https://github.com/aws/aws-iot-device-sdk-python-v2#aws-iot-device-sdk-v2-for-python" rel="noopener noreferrer" target="_blank"><span>
                                                   AWS IoT Device SDK v2 for Python</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>        
                                  
                                 
                                 <h2 id="sdk-tutorials-mqtt-review">Review the MQTT protocol</h2>
                                 
                                 <p>Before we talk about the sample app, it helps to understand the MQTT protocol. The
                                    MQTT protocol offers some advantages over other network communication protocols, such
                                    as
                                    HTTP, which makes it a popular choice for IoT devices. This section reviews the key
                                    aspects of MQTT that apply to this tutorial. For information about how MQTT compares
                                    to
                                    HTTP, see <a href="./protocols.html#protocol-selection">Choosing a protocol for your device
                                       communication</a>.
                                 </p>
                                  
                                 
                                 <p class="title"><b>MQTT uses a publish/subscribe communication model</b></p>
                                 
                                 <p>The MQTT protocol uses a publish/subscribe communication model with its host. This
                                    model differs from the request/response model that HTTP uses. With MQTT, devices
                                    establish a session with the host that is identified by a unique client ID. To send
                                    data, devices publish messages identified by topics to a message broker in the host.
                                    To receive messages from the message broker, devices subscribe to the topics they
                                    will receive by sending topic filters in subscription requests to the message
                                    broker.
                                 </p>
                                  
                                  
                                 
                                 <p class="title"><b>MQTT supports persistent sessions</b></p>
                                 
                                 <p>The message broker receives messages from devices and publishes messages to
                                    devices that have subscribed to them. With <a href="./mqtt.html#mqtt-persistent-sessions">persistent sessions</a> —sessions that remain active even when the
                                    initiating device is disconnected—devices can retrieve messages that were published
                                    while they were disconnected. On the device side, MQTT supports Quality of Service
                                    levels (<a href="./mqtt.html#mqtt-qos">QoS</a>) that ensure the host receives messages
                                    sent by the device.
                                 </p>
                                  
                                  
                                 
                                 <h2 id="sdk-tutorials-explore-sample">Review the pubsub.py Device SDK sample
                                    app
                                 </h2>
                                 
                                 <p>This section reviews the <code class="code">pubsub.py</code> sample app from the <b>AWS IoT Device SDK v2 for Python</b> used in this tutorial. Here,
                                    we'll review how it connects to AWS IoT Core to publish and subscribe to MQTT messages.
                                    The
                                    next section presents some exercises to help you explore how a device connects and
                                    communicates with AWS IoT Core.
                                 </p>
                                 
                                 <div class="highlights" id="inline-topiclist">
                                    <p><strong>The pubsub.py sample app demonstrates these aspects 
                                          of an MQTT connection with AWS IoT Core:</strong></p>
                                    <ul>
                                       <li><a href="#sdk-tutorials-explore-protocols">Communication protocols</a></li>
                                       <li><a href="#sdk-tutorials-explore-persistent">Persistent sessions</a></li>
                                       <li><a href="#sdk-tutorials-explore-qos">Quality of Service</a></li>
                                       <li><a href="#sdk-tutorials-explore-publish">Message publish</a></li>
                                       <li><a href="#sdk-tutorials-explore-subscribe">Message subscription</a></li>
                                       <li><a href="#sdk-tutorials-explore-connect">Device disconnection and
                                             reconnection</a></li>
                                    </ul>
                                 </div>
                                  
                                 
                                 <h3 id="sdk-tutorials-explore-protocols">Communication protocols</h3>
                                 
                                 <p>The <code class="code">pubsub.py</code> sample demonstrates an MQTT connection using the MQTT
                                    and MQTT over WSS protocols. The <a href="https://github.com/awslabs/aws-crt-python#aws-crt-python" rel="noopener noreferrer" target="_blank"><span>AWS common
                                          runtime (AWS CRT)</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> library provides the low-level communication protocol
                                    support and is included with the AWS IoT Device SDK v2 for Python.
                                 </p>
                                  
                                 
                                 <h4 id="sdk-tutorials-explore-mqtt">MQTT</h4>
                                 
                                 <p>The <code class="code">pubsub.py</code> sample calls <code class="code">mtls_from_path</code> (shown
                                    here) in the <a href="https://github.com/awslabs/aws-crt-python/blob/89207bcf1387177034e02fe29e8e469ca45e39b7/awscrt/awsiot_mqtt_connection_builder.py" rel="noopener noreferrer" target="_blank"><span><code class="code">mqtt_connection_builder</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> to establish a connection
                                    with AWS IoT Core by using the MQTT protocol. <code class="code">mtls_from_path</code> uses X.509
                                    certificates and TLS v1.2 to authenticate the device. The AWS CRT library
                                    handles the lower-level details of that connection.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">mqtt_connection = mqtt_connection_builder.mtls_from_path(
    endpoint=args.endpoint,
    cert_filepath=args.cert,
    pri_key_filepath=args.key,
    ca_filepath=args.root_ca,
    client_bootstrap=client_bootstrap,
    on_connection_interrupted=on_connection_interrupted,
    on_connection_resumed=on_connection_resumed,
    client_id=args.client_id,
    clean_session=False,
    keep_alive_secs=6
)</code></pre>
                                 <div class="variablelist">
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                    
                                    <dl>
                                       
                                       <dt><span class="term"><code class="code">endpoint</code></span></dt>
                                       
                                       <dd>
                                          <p>Your AWS account’s IoT device endpoint</p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">cert_filepath</code></span></dt>
                                       
                                       <dd>
                                          <p>The path to the device’s certificate file</p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">pri_key_filepath</code></span></dt>
                                       
                                       <dd>
                                          <p>The path to the device’s private key file that
                                             was created with its certificate file
                                          </p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">ca_filepath</code></span></dt>
                                       
                                       <dd>
                                          <p>The path to the Root CA file. Required only if the 
                                             MQTT server uses a certificate that's not already in your
                                             trust store.
                                          </p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">client_bootstrap</code></span></dt>
                                       
                                       <dd>
                                          <p>The common runtime object that handles socket
                                             communication activities
                                          </p>
                                          
                                          <p>In the sample app, this object is instantiated just prior to the
                                             call to <code class="code">mqtt_connection_builder.mtls_from_path</code>.
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">on_connection_interrupted</code></span></dt>
                                       
                                       <dt><span class="term"><code class="code">on_connection_resumed</code></span></dt>
                                       
                                       <dd>
                                          <p>The callback functions to call when the device’s connection
                                             is interrupted and resumed
                                          </p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">client_id</code></span></dt>
                                       
                                       <dd>
                                          <p>The ID that uniquely identifies this device in the 
                                             AWS Region
                                          </p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">clean_session</code></span></dt>
                                       
                                       <dd>
                                          <p>Whether to start a new persistent session, or,
                                             if one is present, reconnect to an existing one
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">keep_alive_secs</code></span></dt>
                                       
                                       <dd>
                                          <p>The keep alive value, in seconds, to send in the 
                                             <code class="code">CONNECT</code> request. A ping will automatically be
                                             sent at this interval. The server assumes the connection is
                                             lost if it doesn't receive a ping after 1.5 times this value.
                                          </p>
                                       </dd>
                                       
                                    </dl>
                                 </div>
                                  
                                  
                                 
                                 <h4 id="sdk-tutorials-explore-mqtt-wss">MQTT over WSS</h4>
                                 
                                 <p>The <code class="code">pubsub.py</code> sample calls <code class="code">websockets_with_default_aws_signing</code>
                                    (shown here) in the <a href="https://github.com/awslabs/aws-crt-python/blob/89207bcf1387177034e02fe29e8e469ca45e39b7/awscrt/awsiot_mqtt_connection_builder.py" rel="noopener noreferrer" target="_blank"><span><code class="code">mqtt_connection_builder</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> to establish a connection with AWS IoT Core
                                    using the MQTT protocol over WSS. <code class="code">websockets_with_default_aws_signing</code>
                                    creates an MQTT connection over WSS using <a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html">Signature V4</a> to authenticate the device.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">mqtt_connection = mqtt_connection_builder.websockets_with_default_aws_signing(
    endpoint=args.endpoint,
    client_bootstrap=client_bootstrap,
    region=args.signing_region,
    credentials_provider=credentials_provider,
    websocket_proxy_options=proxy_options,
    ca_filepath=args.root_ca,
    on_connection_interrupted=on_connection_interrupted,
    on_connection_resumed=on_connection_resumed,
    client_id=args.client_id,
    clean_session=False,
    keep_alive_secs=6
)
</code></pre>
                                 <div class="variablelist">
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                    
                                    <dl>
                                       
                                       <dt><span class="term"><code class="code">endpoint</code></span></dt>
                                       
                                       <dd>
                                          <p>Your AWS account’s IoT device endpoint</p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">client_bootstrap</code></span></dt>
                                       
                                       <dd>
                                          <p>The common runtime object that handles socket
                                             communication activities
                                          </p>
                                          
                                          <p>In the sample app, this object is instantiated just prior to the
                                             call to 
                                             <code class="code">mqtt_connection_builder.websockets_with_default_aws_signing</code>.
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">region</code></span></dt>
                                       
                                       <dd>
                                          <p>The AWS signing Region used by Signature V4 authentication. In <code class="code">pubsub.py</code>, it
                                             passes the parameter entered in the command line.
                                          </p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">credentials_provider</code></span></dt>
                                       
                                       <dd>
                                          <p>The AWS credentials provided to use for authentication</p>
                                          
                                          <p>In the sample app, this object is instantiated just prior to the
                                             call to 
                                             <code class="code">mqtt_connection_builder.websockets_with_default_aws_signing</code>.
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">websocket_proxy_options</code></span></dt>
                                       
                                       <dd>
                                          <p>HTTP proxy options, if using a proxy host</p>
                                          
                                          <p>In the sample app, this value is initialized just prior to the
                                             call to 
                                             <code class="code">mqtt_connection_builder.websockets_with_default_aws_signing</code>.
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">ca_filepath</code></span></dt>
                                       
                                       <dd>
                                          <p>The path to the Root CA file. Required only if the 
                                             MQTT server uses a certificate that's not already in your
                                             trust store.
                                          </p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">on_connection_interrupted</code></span></dt>
                                       
                                       <dt><span class="term"><code class="code">on_connection_resumed</code></span></dt>
                                       
                                       <dd>
                                          <p>The callback functions to call when the device’s connection
                                             is interrupted and resumed
                                          </p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">client_id</code></span></dt>
                                       
                                       <dd>
                                          <p>The ID that uniquely identifies this device in the 
                                             AWS Region.
                                          </p>
                                          
                                          <p>In the sample app, this value is passed in from the command line.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">clean_session</code></span></dt>
                                       
                                       <dd>
                                          <p>Whether to start a new persistent session, or,
                                             if one is present, reconnect to an existing one
                                          </p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">keep_alive_secs</code></span></dt>
                                       
                                       <dd>
                                          <p>The keep alive value, in seconds, to send in the 
                                             <code class="code">CONNECT</code> request. A ping will automatically be
                                             sent at this interval. The server assumes the connection is
                                             lost if it doesn't receive a ping after 1.5 times this value.
                                          </p>
                                       </dd>
                                       
                                    </dl>
                                 </div>
                                  
                                  
                                 
                                 <h4 id="sdk-tutorials-explore-https">HTTPS</h4>
                                 
                                 <p>What about HTTPS? AWS IoT Core supports devices that publish HTTPS requests.
                                    From a programming perspective, devices send HTTPS requests to AWS IoT Core 
                                    as would any other application. For an example of a Python program that
                                    sends an HTTP message from a device, see the <a href="./http.html#codeexample">HTTPS code example</a> using Python’s <code class="code">requests</code> library.
                                    This example sends a message to AWS IoT Core using HTTPS such that AWS IoT Core 
                                    interprets it as an MQTT message.
                                 </p>
                                 
                                 <p>While AWS IoT Core supports HTTPS requests from devices, be sure to 
                                    review the information about <a href="./protocols.html#protocol-selection">Choosing a protocol for your device
                                       communication</a> so that you can make an
                                    informed decision on which protocol to use for your device communications.
                                 </p>
                                              
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-explore-persistent">Persistent sessions</h3>
                                 
                                 <p>In the sample app, setting the <code class="code">clean_session</code> parameter to
                                    <code class="code">False</code> indicates that the connection should be persistent. In
                                    practice, this means that the connection opened by this call reconnects to an
                                    existing persistent session, if one exists. Otherwise, it creates and connects to
                                    a
                                    new persistent session.
                                 </p>
                                 
                                 <p>With a persistent session, messages that are sent to the device are stored by the
                                    message broker while the device is not connected. When a device reconnects to a
                                    persistent session, the message broker sends to the device any stored messages to
                                    which it has subscribed.
                                 </p>
                                 
                                 <p>Without a persistent session, the device will not receive messages that are sent
                                    while the device isn't connected. Which option to use depends on your application
                                    and whether messages that occur while a device is not connected must be
                                    communicated. For more information, see <a href="./mqtt.html#mqtt-persistent-sessions">Using MQTT persistent
                                       sessions</a>.
                                 </p>
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-explore-qos">Quality of Service</h3>
                                 
                                 <p>When the device publishes and subscribes to messages, the preferred Quality of
                                    Service (QoS) can be set. AWS IoT supports QoS levels 0 and 1 for publish and
                                    subscribe operations. For more information about QoS levels in AWS IoT, see <a href="./mqtt.html#mqtt-qos">MQTT Quality of Service (QoS) options</a>.
                                 </p>
                                 
                                 <p>The AWS CRT runtime for Python defines these constants for the QoS levels that it
                                    supports:
                                 </p>
                                 
                                 <div class="table-container">
                                    <div class="table-contents">
                                       <table id="w332aac11b7c19c11b7">
                                          <thead>
                                             <tr>
                                                <th class="table-header" colspan="100%">
                                                   <div class="title">Python Quality of Service levels</div>
                                                </th>
                                             </tr>
                                             
                                             <tr>
                                                
                                                <th>MQTT QoS level</th>
                                                
                                                <th>Python symbolic value used by SDK</th>
                                                
                                                <th>Description</th>
                                                
                                             </tr>
                                             
                                          </thead>
                                          
                                          <tr>
                                             
                                             <td>QoS level 0</td>
                                             
                                             <td><code class="code">mqtt.QoS.AT_MOST_ONCE</code></td>
                                             
                                             <td>Only one attempt to send the message will be made, whether it is
                                                received or not. The message might not be sent at all, for example,
                                                if the device is not connected or there's a network error.
                                             </td>
                                             
                                          </tr>
                                          
                                          <tr>
                                             
                                             <td>QoS level 1</td>
                                             
                                             <td><code class="code">mqtt.QoS.AT_LEAST_ONCE</code></td>
                                             
                                             <td>The message is sent repeatedly until a <code class="code">PUBACK</code>
                                                acknowledgement is received.
                                             </td>
                                             
                                          </tr>
                                          
                                       </table>
                                    </div>
                                 </div>
                                 
                                 <p>In the sample app, the publish and subscribe requests are
                                    made with a QoS level of 1 (<code class="code">mqtt.QoS.AT_LEAST_ONCE</code>).
                                    
                                 </p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p class="title"><b>QoS on publish</b></p>
                                          
                                          <p>When a device publishes a message with QoS level 1, it sends the message
                                             repeatedly until it receives a <code class="code">PUBACK</code> response from the
                                             message broker. If the device isn't connected, the message is queued to
                                             be sent after it reconnects.
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p class="title"><b>QoS on subscribe</b></p>
                                          
                                          <p>When a device subscribes to a message with QoS level 1, the message broker
                                             saves the messages to which the device is subscribed until they can be
                                             sent to the device. The message broker resends the messages until it
                                             receives a <code class="code">PUBACK</code> response from the device.
                                          </p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-explore-publish">Message publish</h3>
                                 
                                 <p>After successfully establishing a connection to AWS IoT Core, devices can
                                    publish messages. The <code class="code">pubsub.py</code> sample does this by calling
                                    the <code class="code">publish</code> method of the <code class="code">mqtt_connection</code> object.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">mqtt_connection.publish(
    topic=args.topic,
    payload=message,
    qos=mqtt.QoS.AT_LEAST_ONCE
)</code></pre>
                                 <div class="variablelist">
                                     
                                     
                                     
                                    
                                    <dl>
                                       
                                       <dt><span class="term"><code class="code">topic</code></span></dt>
                                       
                                       <dd>
                                          <p>The message's topic name that identifies the message</p>
                                          
                                          <p>In the sample app, this is passed in from the command line.</p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">payload</code></span></dt>
                                       
                                       <dd>
                                          <p>The message payload formatted as a string (for example, a JSON document)</p>
                                          
                                          <p>In the sample app, this is passed in from the command
                                             line.
                                          </p>
                                          
                                          <p>A JSON document is a common payload format, and one that is recognized
                                             by other AWS IoT services; however, the data format of the message payload
                                             can be anything that the publishers and subscribers agree upon. Other AWS IoT
                                             services, however, only recognize JSON, and CBOR, in some cases, for
                                             most operations.
                                          </p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">qos</code></span></dt>
                                       
                                       <dd>
                                          <p>The QoS level for this message</p>
                                       </dd>
                                       
                                    </dl>
                                 </div>
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-explore-subscribe">Message subscription</h3>
                                 
                                 <p>To receive messages from AWS IoT and other services and devices, devices subscribe
                                    to those messages by their topic name. Devices can subscribe to individual messages
                                    by specifying a <a href="./topics.html#topicnames">topic name</a>, and to a group of
                                    messages by specifying a <a href="./topics.html#topicfilters">topic filter</a>, which can
                                    include wild card characters. The <code class="code">pubsub.py</code> sample uses the code shown
                                    here to subscribe to messages and register the callback functions to process the
                                    message after it’s received.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">subscribe_future, packet_id = mqtt_connection.subscribe(
    topic=args.topic,
    qos=mqtt.QoS.AT_LEAST_ONCE,
    callback=on_message_received
)
subscribe_result = subscribe_future.result()
</code></pre>
                                 <div class="variablelist">
                                     
                                     
                                     
                                    
                                    <dl>
                                       
                                       <dt><span class="term"><code class="code">topic</code></span></dt>
                                       
                                       <dd>
                                          <p>The topic to subscribe to. This can be a
                                             topic name or a topic filter.
                                          </p>
                                          
                                          <p>In the sample app, this is passed in from the command
                                             line.
                                          </p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">qos</code></span></dt>
                                       
                                       <dd>
                                          <p>Whether the message broker should store these
                                             messages while the device is disconnected.
                                          </p>
                                          
                                          <p>A value of <code class="code">mqtt.QoS.AT_LEAST_ONCE</code>
                                             (QoS level 1), requires a persistent session to
                                             be specified (<code class="code">clean_session=False</code>) when 
                                             the connection is created.
                                          </p>
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">callback</code></span></dt>
                                       
                                       <dd>
                                          <p>The function to call to process the subscribed
                                             message.
                                          </p>
                                       </dd>
                                       
                                    </dl>
                                 </div>
                                 
                                 <p>The <code class="code">mqtt_connection.subscribe</code> function returns a future and a packet
                                    ID. If the subscription request was initiated successfully, the packet ID returned
                                    is greater than 0. To make sure the subscription was received and registered by the
                                    message broker, you must wait for the result of the asynchronous operation to
                                    return, as shown in the code example.
                                 </p>
                                  
                                 
                                 <p class="title"><b>The callback function</b></p>
                                 
                                 <p>The callback in the <code class="code">pubsub.py</code> sample processes
                                    the subscribed messages as the device receives them.
                                 </p>
                                  
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">def on_message_received(topic, payload, **kwargs):
    print("Received message from topic '<span>{</span>}': <span>{</span>}".format(topic, payload))
    global received_count
    received_count += 1
    if received_count == args.count:
        received_all_event.set()</code></pre>
                                 <div class="variablelist">
                                     
                                     
                                     
                                    
                                    <dl>
                                       
                                       <dt><span class="term"><code class="code">topic</code></span></dt>
                                       
                                       <dd>
                                          
                                          <p>The message’s topic</p>
                                          
                                          <p>This is the specific topic name of the message received, even if you
                                             subscribed to a topic filter.
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">payload</code></span></dt>
                                       
                                       <dd>
                                          
                                          <p>The message payload</p>
                                          
                                          <p>The format for this is application specific.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term"><code class="code">kwargs</code></span></dt>
                                       
                                       <dd>
                                          <p>Possible additional arguments as 
                                             described in <a href="https://awslabs.github.io/aws-crt-python/api/mqtt.html#awscrt.mqtt.Connection.subscribe" rel="noopener noreferrer" target="_blank"><span><code class="code">mqtt.Connection.subscribe</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                          </p>
                                       </dd>
                                       
                                    </dl>
                                 </div>
                                 
                                 <p>In the <code class="code">pubsub.py</code> sample, 
                                    <code class="code">on_message_received</code> only displays the
                                    topic and its payload. It also counts the messages
                                    received to end the program after the limit is reached.
                                 </p>
                                 
                                 <p>Your app would evaluate the topic and the payload to determine
                                    what actions to perform.
                                 </p>
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-explore-connect">Device disconnection and
                                    reconnection
                                 </h3>
                                 
                                 <p>The <code class="code">pubsub.py</code> sample includes callback
                                    functions that are called when the device is disconnected
                                    and when the connection is re-established. What actions
                                    your device takes on these events is application specific.
                                 </p>
                                 
                                 <p>When a device connects for the first time, it must subscribe to topics to receive.
                                    If a device's session is present when it reconnects, its subscriptions are restored,
                                    and any stored messages from those subscriptions are sent to the device after it
                                    reconnects.
                                 </p>
                                 
                                 <p>If a device's session no longer exists when it reconnects, it must resubscribe to
                                    its subscriptions. Persistent sessions have a limited lifetime and can expire when
                                    the device is disconnected for too long.
                                 </p>
                                  
                                  
                                 
                                 <h2 id="sdk-tutorials-experiment">Connect your device and communicate with AWS IoT Core</h2>
                                 
                                 <p>This section presents some exercises to help you explore different aspects of
                                    connecting your device to AWS IoT Core. For these exercises, you’ll use the <a href="https://console.aws.amazon.com/iot/home#/test" rel="noopener noreferrer" target="_blank"><span>MQTT test client</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> in the
                                    AWS IoT console to see what your device publishes and to publish messages to your
                                    device.
                                    These exercises use the <a href="https://github.com/aws/aws-iot-device-sdk-python-v2/blob/master/samples/pubsub.py" rel="noopener noreferrer" target="_blank"><span><code class="code">pubsub.py</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> sample from the <a href="https://github.com/aws/aws-iot-device-sdk-python-v2/tree/master/samples#sample-apps-for-the-aws-iot-device-sdk-v2-for-python" rel="noopener noreferrer" target="_blank"><span>AWS IoT Device SDK v2 for Python</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> and build on your experience with <a href="./iot-gs.html">Getting started with AWS IoT Core</a> tutorials.
                                    
                                 </p>
                                 
                                 <div class="highlights" id="inline-topiclist">
                                    <p><strong>In this section, you'll:</strong></p>
                                    <ul>
                                       <li><a href="#sdk-tutorials-experiment-wild">Subscribe to wild card topic
                                             filters</a></li>
                                       <li><a href="#sdk-tutorials-experiment-process">Process topic filter
                                             subscriptions</a></li>
                                       <li><a href="#sdk-tutorials-experiement-publish">Publish messages from your
                                             device</a></li>
                                    </ul>
                                 </div>
                                 
                                 <p>For these exercises, you'll start from the <code class="code">pubsub.py</code> sample
                                    program.
                                 </p>
                                 
                                 <div class="awsdocs-note">
                                    <div class="awsdocs-note-title">
                                       <awsui-icon name="status-info" variant="link"></awsui-icon><span>Note</span></div>
                                    <div class="awsdocs-note-text">
                                       <p>These exercises assume that you completed the <a href="./iot-gs.html">Getting started with AWS IoT Core</a> tutorials and use the terminal window for your device from that
                                          tutorial.
                                       </p>
                                    </div>
                                 </div>
                                  
                                 
                                 <h3 id="sdk-tutorials-experiment-wild">Subscribe to wild card topic
                                    filters
                                 </h3>
                                 
                                 <p>In this exercise, you’ll modify the command line used to call
                                    <code class="code">pubsub.py</code> to subscribe to a wild card topic filter and process the
                                    messages received based on the message’s topic.
                                 </p>
                                  
                                 
                                 <h4 id="sdk-tutorials-experiment-wild-steps">Exercise procedure</h4>
                                 
                                 <p>For this exercise, imagine that your device contains a temperature control and a
                                    light control. It uses these topic names to identify the messages about them.
                                 </p>
                                 
                                 <div class="procedure">
                                    <ol>
                                       <li>
                                          
                                          <p>Before starting the exercise, try running this command from the <a href="./iot-gs.html">Getting started with AWS IoT Core</a> tutorials on your device to make
                                             sure everything is ready for the exercise.
                                          </p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="bash ">cd ~/aws-iot-device-sdk-python-v2/samples
python3 pubsub.py --topic topic_1 --root-ca ~/certs/Amazon-root-CA-1.pem --cert ~/certs/device.pem.crt --key ~/certs/private.pem.key —endpoint <code class="replaceable">your-iot-endpoint</code>
</code></pre>
                                          <p>You should see the same output as you saw in the <a href="./connecting-to-existing-device.html#gs-device-node-app-run">Getting started tutorial</a>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>For this exercise, change these command line parameters.</p>
                                          
                                          <div class="table-container">
                                             <div class="table-contents">
                                                <table id="w332aac11b7c21c11b5b5b3b3">
                                                   <thead>
                                                      
                                                      <tr>
                                                         
                                                         <th>
                                                            
                                                            <p>Action</p>
                                                            
                                                         </th>
                                                         
                                                         <th>
                                                            
                                                            <p>Command line parameter</p>
                                                            
                                                         </th>
                                                         
                                                         <th>
                                                            
                                                            <p>Effect</p>
                                                            
                                                         </th>
                                                         
                                                      </tr>
                                                      
                                                   </thead>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p>add</p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><b>--message</b>
                                                            <code class="code">""</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p>Configure <code class="code">pubsub.py</code> to listen only
                                                            
                                                         </p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p>add</p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><b>--count</b>
                                                            <code class="code">2</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p>End the program after receiving two messages</p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p>change</p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><b>--topic</b>
                                                            <code class="code">device/+/details</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p>Define the topic filter to subscribe to</p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                </table>
                                             </div>
                                          </div>
                                          
                                          <p>Making these changes to the initial command line results in this command
                                             line. Enter this command in the terminal window for your device.
                                          </p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="bash ">python3 pubsub.py --message "" --count 2 --topic device/+/details --root-ca ~/certs/Amazon-root-CA-1.pem --cert ~/certs/device.pem.crt --key ~/certs/private.pem.key —endpoint <code class="replaceable">your-iot-endpoint</code>
</code></pre>
                                          <p>The program should display something like this:</p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">Connecting to a3qexamplesffp-ats.iot.us-west-2.amazonaws.com with client ID 'test-24d7cdcc-cc01-458c-8488-2d05849691e1'...
Connected!
Subscribing to topic 'device/+/details'...
Subscribed with QoS.AT_LEAST_ONCE
Waiting for all messages to be received...
</code></pre>
                                          <p>If you see something like this on your terminal, your device is ready and
                                             listening for messages where the topic names start with
                                             <code class="code">topic-1/</code> and end with <code class="code">/detail</code>. So, let's test
                                             that.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Here are a couple of messages that your device might receive.</p>
                                          
                                          <div class="table-container">
                                             <div class="table-contents">
                                                <table id="w332aac11b7c21c11b5b5b5b3">
                                                   <thead>
                                                      
                                                      <tr>
                                                         
                                                         <th>
                                                            
                                                            <p>Topic name</p>
                                                            
                                                         </th>
                                                         
                                                         <th>
                                                            
                                                            <p>Message payload</p>
                                                            
                                                         </th>
                                                         
                                                      </tr>
                                                      
                                                   </thead>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code">device/temp/details</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code"><span>{</span> "desiredTemp": 20, "currentTemp": 15
                                                               }</code></p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code">device/light/details</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code"><span>{</span> "desiredLight": 100, "currentLight": 50
                                                               }</code></p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                </table>
                                             </div>
                                          </div>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Using the MQTT test client in the AWS IoT console, send the messages
                                             described in the previous step to your device.
                                          </p>
                                          
                                          <ol>
                                             <li>
                                                
                                                <p>Open the <a href="https://console.aws.amazon.com/iot/home#/test" rel="noopener noreferrer" target="_blank"><span>MQTT test
                                                         client</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> in the AWS IoT console.
                                                </p>
                                                
                                             </li>
                                             <li>
                                                
                                                <p>In <b>Subscribe to a topic</b>, in the
                                                   <b>Subscription topic field</b>, enter the topic
                                                   filter: <code class="userinput">device/+/details</code>, and then choose
                                                   <b>Subscribe to topic</b>.
                                                </p>
                                                
                                             </li>
                                             <li>
                                                
                                                <p>In the <b>Subscriptions</b> column of the MQTT test
                                                   client, choose <b>device/+/details</b>.
                                                </p>
                                                
                                             </li>
                                             <li>
                                                
                                                <p>For each of the topics in the preceding table, do the following in
                                                   the MQTT test client:
                                                </p>
                                                
                                                <div class="orderedlist">
                                                    
                                                    
                                                    
                                                   
                                                   <ol>
                                                      <li>
                                                         
                                                         <p>In <b>Publish</b>, enter the value from the
                                                            <b>Topic name</b> column in the
                                                            table.
                                                         </p>
                                                         
                                                      </li>
                                                      <li>
                                                         
                                                         <p>In the message payload field below the topic name,
                                                            enter the value from the <b>Message
                                                               payload</b> column in the table.
                                                         </p>
                                                         
                                                      </li>
                                                      <li>
                                                         
                                                         <p>Watch the terminal window where <code class="code">pubsub.py</code> is
                                                            running and, in the MQTT test client, choose
                                                            <b>Publish to topic</b>.
                                                         </p>
                                                         
                                                      </li>
                                                   </ol>
                                                </div>
                                                
                                                <p>You should see that the message was received by
                                                   <code class="code">pubsub.py</code> in the terminal window.
                                                </p>
                                                
                                             </li>
                                          </ol>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                  
                                  
                                 
                                 <h4 id="sdk-tutorials-experiment-wild-result">Exercise result</h4>
                                 
                                 <p>With this, <code class="code">pubsub.py</code>, subscribed to the messages using a wild card
                                    topic filter, received them, and displayed them in the terminal window. Notice how
                                    you subscribed to a single topic filter, and the callback function was called to
                                    process messages having two distinct topics.
                                 </p>
                                  
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-experiment-process">Process topic filter
                                    subscriptions
                                 </h3>
                                 
                                 <p>Building on the previous exercise, modify the <code class="code">pubsub.py</code> sample app to
                                    evaluate the message topics and process the subscribed messages based on the
                                    topic.
                                 </p>
                                  
                                 
                                 <h4 id="sdk-tutorials-experiment-process-steps">Exercise
                                    procedure
                                 </h4>
                                 
                                 <div class="procedure">
                                    <p class="title"><b>To evaluate the message topic</b></p>
                                    <ol>
                                       <li>
                                          
                                          <p>Copy <code class="code">pubsub.py</code> to <code class="code">pubsub2.py</code>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Open <code class="code">pubsub2.py</code> in your favorite text editor or
                                             IDE.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>In <code class="code">pubsub2.py</code>, find the <code class="code">on_message_received</code>
                                             function.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>In <code class="code">on_message_received</code>, insert the following code after
                                             the line that starts with <code class="code">print("Received message</code> and
                                             before the line that starts with <code class="code">global
                                                received_count</code>.
                                          </p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">    topic_parsed = False
    if "/" in topic:
        parsed_topic = topic.split("/")
        if len(parsed_topic) == 3:
            # this topic has the correct format
            if (parsed_topic[0] == 'device') and (parsed_topic[2] == 'details'):
                # this is a topic we care about, so check the 2nd element
                if (parsed_topic[1] == 'temp'):
                    print("Received temperature request: <span>{</span>}".format(payload))
                    topic_parsed = True
                if (parsed_topic[1] == 'light'):
                    print("Received light request: <span>{</span>}".format(payload))
                    topic_parsed = True
    if not topic_parsed:
        print("Unrecognized message topic.")
</code></pre>
                                          </li>
                                       <li>
                                          
                                          <p>Save your changes and run the modified program by using this command
                                             line.
                                          </p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="bash ">python3 pubsub2.py --message "" --count 2 --topic device/+/details --root-ca ~/certs/Amazon-root-CA-1.pem --cert ~/certs/device.pem.crt --key ~/certs/private.pem.key —endpoint <code class="replaceable">your-iot-endpoint</code>
</code></pre>
                                          </li>
                                       <li>
                                          
                                          <p>In the AWS IoT console, open the <a href="https://console.aws.amazon.com/iot/home#/test" rel="noopener noreferrer" target="_blank"><span>MQTT test
                                                   client</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>In <b>Subscribe to a topic</b>, in the
                                             <b>Subscription topic field</b>, enter the topic
                                             filter: <code class="userinput">device/+/details</code>, and then choose
                                             <b>Subscribe to topic</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>In the <b>Subscriptions</b> column of the MQTT test
                                             client, choose <b>device/+/details</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>For each of the topics in this table, do the following in the MQTT
                                             test client:
                                          </p>
                                          
                                          <div class="table-container">
                                             <div class="table-contents">
                                                <table id="w332aac11b7c21c13b5b3c18b3">
                                                   <thead>
                                                      
                                                      <tr>
                                                         
                                                         <th>
                                                            
                                                            <p>Topic name</p>
                                                            
                                                         </th>
                                                         
                                                         <th>
                                                            
                                                            <p>Message payload</p>
                                                            
                                                         </th>
                                                         
                                                      </tr>
                                                      
                                                   </thead>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code">device/temp/details</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code"><span>{</span> "desiredTemp": 20, "currentTemp": 15
                                                               }</code></p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                   <tr>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code">device/light/details</code></p>
                                                         
                                                      </td>
                                                      
                                                      <td>
                                                         
                                                         <p><code class="code"><span>{</span> "desiredLight": 100, "currentLight": 50
                                                               }</code></p>
                                                         
                                                      </td>
                                                      
                                                   </tr>
                                                   
                                                </table>
                                             </div>
                                          </div>
                                          
                                          <div class="orderedlist">
                                              
                                              
                                              
                                             
                                             <ol>
                                                <li>
                                                   
                                                   <p>In <b>Publish</b>, enter the value from the
                                                      <b>Topic name</b> column in the table.
                                                   </p>
                                                   
                                                </li>
                                                <li>
                                                   
                                                   <p>In the message payload field below the topic name, enter the
                                                      value from the <b>Message payload</b> column in
                                                      the table.
                                                   </p>
                                                   
                                                </li>
                                                <li>
                                                   
                                                   <p>Watch the terminal window where <code class="code">pubsub.py</code> is
                                                      running and, in the MQTT test client, choose <b>Publish
                                                         to topic</b>.
                                                   </p>
                                                   
                                                </li>
                                             </ol>
                                          </div>
                                          
                                          <p>You should see that the message was received by <code class="code">pubsub.py</code>
                                             in the terminal window.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 
                                 <p>You should see something similar to this in your terminal window.</p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">Connecting to a3qexamplesffp-ats.iot.us-west-2.amazonaws.com with client ID 'test-af794be0-7542-45a0-b0af-0b0ea7474517'...
Connected!
Subscribing to topic 'device/+/details'...
Subscribed with QoS.AT_LEAST_ONCE
Waiting for all messages to be received...
Received message from topic 'device/light/details': b'<span>{</span> "desiredLight": 100, "currentLight": 50 }'
Received light request: b'<span>{</span> "desiredLight": 100, "currentLight": 50 }'
Received message from topic 'device/temp/details': b'<span>{</span> "desiredTemp": 20, "currentTemp": 15 }'
Received temperature request: b'<span>{</span> "desiredTemp": 20, "currentTemp": 15 }'
2 message(s) received.
Disconnecting...
Disconnected!
</code></pre>
                                  
                                  
                                 <h4 id="sdk-tutorials-experiment-process-result">Exercise result</h4>
                                 
                                 <p>In this exercise, you added code so the sample app would recognize and process
                                    multiple messages in the callback function. With this, your device could receive
                                    messages and act on them.
                                 </p>
                                 
                                 <p>Another way for your device to receive and process multiple messages would be to
                                    subscribe to different messages separately and assign each subscription to its own
                                    callback function.
                                 </p>
                                  
                                  
                                  
                                 
                                 <h3 id="sdk-tutorials-experiement-publish">Publish messages from your
                                    device
                                 </h3>
                                 
                                 <p>You can use the pubsub.py sample app to publish messages from your device. While
                                    it will publish messages as it is, the messages can't be read as JSON documents.
                                    This exercise modifies the sample app to be able to publish JSON documents in the
                                    message payload that can be read by AWS IoT Core.
                                 </p>
                                  
                                 
                                 <h4 id="sdk-tutorials-experiment-publish-steps">Exercise procedure</h4>
                                 
                                 <p>In this exercise, the following message will be sent with the
                                    <code class="code">device/data</code> topic.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "timestamp": 1601048303,
    "sensorId": 28,
    "sensorData": [
        <span>{</span>
        "sensorName": "Wind speed",
        "sensorValue": 34.2211224
        }
    ]
}
</code></pre>
                                 <div class="procedure">
                                    <p class="title"><b>To prepare your MQTT test client to monitor the messages from this
                                          exercise</b></p>
                                    <ol>
                                       <li>
                                          
                                          <p>In <b>Subscribe to a topic</b>, in the
                                             <b>Subscription topic field</b>, enter the topic filter:
                                             <code class="userinput">device/data</code>, and then choose <b>Subscribe
                                                to topic</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>In the <b>Subscriptions</b> column of the MQTT test client,
                                             choose <b>device/data</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Leave the MQTT test client window open to wait for messages from your
                                             device.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 
                                 <div class="procedure">
                                    <p class="title"><b>To send JSON documents with the pubsub.py sample app</b></p>
                                    <ol>
                                       <li>
                                          
                                          <p>On your device, copy <code class="code">pubsub.py</code> to
                                             <code class="code">pubsub3.py</code>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Edit <code class="code">pubsub3.py</code> to change how it formats the messages it
                                             publishes.
                                          </p>
                                          
                                          <ol>
                                             <li>
                                                
                                                <p>Open <code class="code">pubsub3.py</code> in a text editor.
                                                </p>
                                                
                                             </li>
                                             <li>
                                                
                                                <p>Locate this line of code:</p>
                                                
                                                <p><code class="code">message = "<span>{</span>} [<span>{</span>}]".format(args.message,
                                                      publish_count)</code></p>
                                                
                                             </li>
                                             <li>
                                                
                                                <p>Change it to:</p>
                                                
                                                <p><code class="code">message = "<span>{</span>}".format(args.message)</code></p>
                                                
                                             </li>
                                             <li>
                                                
                                                <p>Save your changes.</p>
                                                
                                             </li>
                                          </ol>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>On your device, run this command to send the message two times.</p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="bash ">python3 pubsub3.py  --root-ca ~/certs/Amazon-root-CA-1.pem  --cert ~/certs/device.pem.crt  --key ~/certs/private.pem.key  --topic device/data  --count 2 --message '<span>{</span>"timestamp":1601048303,"sensorId":28,"sensorData":[<span>{</span>"sensorName":"Wind speed","sensorValue":34.2211224}]}'  --endpoint <code class="replaceable">your-iot-endpoint</code>
</code></pre>
                                          </li>
                                       <li>
                                          
                                          <p>In the MQTT test client, check to see that it has interpreted and
                                             formatted the JSON document in the message payload, such as this:
                                          </p>
                                          
                                          <div class="mediaobject">
                                              
                                             <img src="images/mqtt-test-client-output.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                                Image showing how a JSON message payload is displayed in the&#xA;                                    MQTT client of the AWS IoT console.&#xA;                            " />
                                              
                                              
                                             
                                          </div>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 
                                 <p>By default, <code class="code">pubsub3.py</code> also subscribes to the messages it sends.
                                    You should see that it received the messages in the app’s output. The terminal
                                    window should look something like this.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">Connecting to a3qj468xinsffp-ats.iot.us-west-2.amazonaws.com with client ID 'test-5cff18ae-1e92-4c38-a9d4-7b9771afc52f'...
Connected!
Subscribing to topic 'device/data'...
Subscribed with QoS.AT_LEAST_ONCE
Sending 2 message(s)
Publishing message to topic 'device/data': <span>{</span>"timestamp":1601048303,"sensorId":28,"sensorData":[<span>{</span>"sensorName":"Wind speed","sensorValue":34.2211224}]}
Received message from topic 'device/data': b'<span>{</span>"timestamp":1601048303,"sensorId":28,"sensorData":[<span>{</span>"sensorName":"Wind speed","sensorValue":34.2211224}]}'
Publishing message to topic 'device/data': <span>{</span>"timestamp":1601048303,"sensorId":28,"sensorData":[<span>{</span>"sensorName":"Wind speed","sensorValue":34.2211224}]}
Received message from topic 'device/data': b'<span>{</span>"timestamp":1601048303,"sensorId":28,"sensorData":[<span>{</span>"sensorName":"Wind speed","sensorValue":34.2211224}]}'
2 message(s) received.
Disconnecting...
Disconnected!
</code></pre>
                                  
                                  
                                 <h4 id="sdk-tutorials-experiment-publish-result">Exercise result</h4>
                                 
                                 <p>With this, your device can generate messages to send to AWS IoT Core to test basic
                                    connectivity and provide device messages for AWS IoT Core to process. For example,
                                    you
                                    could use this app to send test data from your device to test AWS IoT rule
                                    actions.
                                 </p>
                                  
                                  
                                  
                                 
                                 <h2 id="sdk-tutorials-conclusion">Review the results</h2>
                                 
                                 <p>The examples in this tutorial gave you hands-on experience with the basics of how
                                    devices can communicate with AWS IoT Core—a fundamental part of your AWS IoT solution.
                                    When your devices are able to communicate with AWS IoT Core, they can pass messages
                                    to AWS
                                    services and other devices on which they can act. Likewise, AWS services and other
                                    devices can process information that results in messages sent back to your
                                    devices.
                                 </p>
                                 
                                 <p>When you are ready to explore AWS IoT Core further, try these tutorials:</p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          <p><a href="./iot-sns-rule.html">Send an Amazon SNS notification</a></p>
                                       </li>
                                       <li class="listitem">
                                          <p><a href="./iot-ddb-rule.html">Store device data in a DynamoDB table</a></p>
                                       </li>
                                       <li class="listitem">
                                          <p><a href="./iot-lambda-rule.html">Format a notification by using an AWS Lambda function</a></p>
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 <awsdocs-copyright class="copyright-print"></awsdocs-copyright>
                                 <awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback>
                              </div>
                              <noscript>
                                 <div>
                                    <div>
                                       <div>
                                          <div id="js_error_message">
                                             <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your
                                                   browser.</strong></p>
                                             <p>To use the Amazon Web Services Documentation, Javascript must be
                                                enabled. Please refer to your browser's Help pages for instructions.
                                             </p>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </noscript>
                              <div id="main-col-footer" class="awsui-util-font-size-0">
                                 <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                                 <div class="prev-next">
                                    <div id="previous" class="prev-link" accesskey="p" href="./iot-tutorials.html">AWS IoT Tutorials</div>
                                    <div id="next" class="next-link" accesskey="n" href="./iot-embedded-c-sdk.html">Using the AWS IoT Device SDK for Embedded C</div>
                                 </div>
                              </div>
                              <awsdocs-page-utilities></awsdocs-page-utilities>
                           </div>
                           <div id="quick-feedback-yes" style="display: none;">
                              <div class="title">Did this page help you? - Yes</div>
                              <div class="content">
                                 <p>Thanks for letting us know we're doing a good
                                    job!
                                 </p>
                                 <p>If you've got a moment, please tell us what we did right
                                    so we can do more of it.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/sdk-tutorials.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                           <div id="quick-feedback-no" style="display: none;">
                              <div class="title">Did this page help you? - No</div>
                              <div class="content">
                                 <p>Thanks for letting us know this page needs work. We're
                                    sorry we let you down.
                                 </p>
                                 <p>If you've got a moment, please tell us how we can make
                                    the documentation better.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/sdk-tutorials.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                        </div>
                     </body>
                  </div>
               </awsdocs-view>
               <div class="page-loading-indicator" id="page-loading-indicator">
                  <awsui-spinner size="large"></awsui-spinner>
               </div>
            </div>
            <div id="tools-panel" dom-region="tools">
               <awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel>
            </div>
         </awsui-app-layout>
         <awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner>
         <!--
                SiteCatalyst code version: H.25.2.
                Copyright 1996-2012 Adobe, Inc. All Rights Reserved
                More info available at http://www.omniture.com
            --><script language="JavaScript" type="text/javascript">
var awsdocs = awsdocs || {};
awsdocs.prop66 = 'AWS IoT Core';
awsdocs.prop65 =  'Developer Guide';
            </script><script src="https://a0.awsstatic.com/s_code/js/3.0/awshome_s_code.js" language="JavaScript" type="text/javascript"></script>
         <!--/DO NOT REMOVE/-->
         <!--End SiteCatalyst code version: H.25.2.--></div>
   </body>
</html>