<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="AWSDocsDocPageApp">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Pre-provisioning hooks - AWS IoT Core</title>
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <meta name="assets_root" content="assets" />
      <meta name="target_state" content="pre-provisioning-hook" />
      <meta name="default_state" content="pre-provisioning-hook" />
      <link rel="icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="canonical" href="https://docs.aws.amazon.com/iot/latest/developerguide/pre-provisioning-hook.html" />
      <meta name="description" content="When using AWS IoT fleet provisioning, you can set up a Lambda function to validate parameters passed from the device before allowing the device to be provisioned. This Lambda function must exist in your account before you provision a device because it's called every time a device sends a request through" />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="AWS IoT Core" />
      <meta name="guide" content="Developer Guide" />
      <meta name="locales" content="de_de:Deutsch/en_us:English/es_es:Español/fr_fr:Français/it_it:Italiano/ja_jp:日本語/ko_kr:한국어/pt_br:Português/zh_cn:中文 (简体)/zh_tw:中文 (繁體)" />
      <meta name="abstract" content="AWS IoT provides secure, bi-directional communication between Internet-connected devices such as sensors, actuators, embedded micro-controllers, or smart appliances and the AWS Cloud. This enables you to collect telemetry data from multiple devices, and store and analyze the data. You can also create applications that enable your users to control these devices from their phones or tablets." />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <meta name="feedback-item" content="IoT Docs" />
      <meta name="this_doc_product" content="AWS IoT Core" />
      <meta name="this_doc_guide" content="Developer Guide" />
      <link href="assets/css/vendor4.css" rel="stylesheet" />
      <link href="assets/css/awsdocs-common.css" rel="stylesheet" /><script type="text/javascript" src="assets/js/vendor3.js" defer=""></script><script type="text/javascript" src="assets/js/vendor4.js" defer=""></script><script type="text/javascript" src="assets/js/vendor1.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-common.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-doc-app.js" defer=""></script></head>
   <body class="awsdocs awsui">
      <div class="awsdocs-container">
         <awsdocs-header></awsdocs-header>
         <awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)">
            <div id="guide-toc" dom-region="navigation">
               <awsdocs-toc></awsdocs-toc>
            </div>
            <div id="main-column" dom-region="content" tabindex="-1">
               <awsdocs-view class="awsdocs-view">
                  <div id="awsdocs-content">
                     <head>
                        <title>Pre-provisioning hooks - AWS IoT Core</title>
                        <meta name="pdf" content="iot-dg.pdf#pre-provisioning-hook" />
                        <meta name="kindle" content="https://www.amazon.com/dp/B07JBRCWWZ" />
                        <meta name="github" content="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/pre-provisioning-hook.md" />
                        <meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=210" />
                        <meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT%20Docs&amp;topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/pre-provisioning-hook.html" />
                        <meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/pre-provisioning-hook.html" />
                        <meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/pre-provisioning-hook.html" />
                        <meta name="keywords" content="AWS IoT,IoT,Internet of Things" />
                     </head>
                     <body>
                        <div id="main">
                           <div style="display: none"><a href="iot-dg.pdf#pre-provisioning-hook" target="_blank" rel="noopener noreferrer" title="Open PDF"></a><a target="_blank" rel="noopener noreferrer" href="https://www.amazon.com/dp/B07JBRCWWZ" title="Open Kindle"></a><a href="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/pre-provisioning-hook.md" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub"></a></div>
                           <div id="breadcrumbs" class="breadcrumb"><a href="http://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/iot/index.html">AWS IoT Core</a><a href="what-is-aws-iot.html">Developer Guide</a></div>
                           <div id="page-toc-src"><a href="#pre-provisioning-hook-input">Pre-provision hook input</a><a href="#pre-provisioning-hook-output">Pre-provision hook return
                                 value</a><a href="#pre-provisioning-example">Pre-provisioning hook Lambda example</a></div>
                           <div id="main-content" class="awsui-util-container">
                              <div id="main-col-body">
                                 <awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner>
                                 <h1 class="topictitle" id="pre-provisioning-hook">Pre-provisioning hooks</h1>
                                 <div class="awsdocs-page-header-container">
                                    <awsdocs-page-header></awsdocs-page-header>
                                    <awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector>
                                 </div>
                                 <p>When using AWS IoT fleet provisioning, you can set up a Lambda function to validate
                                    parameters passed from the device before allowing the device to be provisioned. This
                                    Lambda function must exist in your account before you provision a device because it's
                                    called every time a device sends a request through <a href="./fleet-provision-api.html#register-thing">RegisterThing</a>. For
                                    devices to be provisioned, your Lambda function must accept the input object and return
                                    the output object described in this section. The provisioning proceeds only if the
                                    Lambda
                                    function returns an object with <code class="code">"allowProvisioning": True</code>.
                                 </p>
                                 <div class="awsdocs-note awsdocs-important">
                                    <div class="awsdocs-note-title">
                                       <awsui-icon name="status-warning" variant="error"></awsui-icon><span>Important</span></div>
                                    <div class="awsdocs-note-text">
                                       <p>AWS recommends using pre-provisioning hooks when creating provisioning templates
                                          to allow more control of which and how many devices your account onboards.
                                       </p>
                                    </div>
                                 </div>
                                 
                                 <h2 id="pre-provisioning-hook-input">Pre-provision hook input</h2>
                                 
                                 <p>AWS IoT sends this object to the Lambda function when a device registers with
                                    AWS IoT.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "claimCertificateId" : "<code class="replaceable">string</code>",
    "certificateId" : "<code class="replaceable">string</code>",
    "certificatePem" : "<code class="replaceable">string</code>",
    "templateArn" : "arn:aws:<code class="replaceable">iot:us-east-1</code>:<code class="replaceable">1234567890</code>:provisioningtemplate/<code class="replaceable">MyTemplate</code>",
    "clientId" : "<code class="replaceable">221a6d10-9c7f-42f1-9153-e52e6fc869c1</code>",
    "parameters" : <span>{</span>
        "<code class="replaceable">string</code>" : "<code class="replaceable">string</code>",
        ...
    }
}</code></pre>
                                 <p>The <code class="code">parameters</code> object passed to the Lambda function contains the
                                    properties in the <code class="code">parameters</code> argument passed in the <a href="./fleet-provision-api.html#register-thing">RegisterThing</a> request payload. 
                                 </p>
                                  
                                 
                                 <h2 id="pre-provisioning-hook-output">Pre-provision hook return
                                    value
                                 </h2>
                                 
                                 <p>The Lambda function must return a response that indicates whether it has authorized
                                    the provisioning request and the values of any properties to override.
                                 </p>
                                 
                                 <p>The following is an example of a successful response from the pre-provisioning
                                    function.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "allowProvisioning": true,
    "parameterOverrides" : <span>{</span>
        "Key": "newCustomValue",
        ...
    }
}</code></pre>
                                 <p><code class="code">"parameterOverrides"</code> values will be added to
                                    <code class="code">"parameters"</code> parameter of  the <a href="./fleet-provision-api.html#register-thing">RegisterThing</a>
                                    request payload.
                                 </p>
                                 
                                 <div class="awsdocs-note">
                                    <div class="awsdocs-note-title">
                                       <awsui-icon name="status-info" variant="link"></awsui-icon><span>Note</span></div>
                                    <div class="awsdocs-note-text">
                                       <div class="itemizedlist">
                                           
                                           
                                          
                                          <ul class="itemizedlist" type="disc">
                                             <li class="listitem">
                                                
                                                <p>If the Lambda function fails or doesn't return the
                                                   <code class="code">"allowProvisioning"</code> parameter in the response, the
                                                   provisioning request will fail and the error will be returned in the
                                                   response.
                                                </p>
                                                
                                             </li>
                                             <li class="listitem">
                                                
                                                <p>The Lambda function must finish running and return within 5 seconds,
                                                   otherwise the provisioning request fails.
                                                </p>
                                                
                                             </li>
                                          </ul>
                                       </div>
                                    </div>
                                 </div>
                                  
                                 
                                 <h2 id="pre-provisioning-example">Pre-provisioning hook Lambda example</h2>
                                 
                                 <awsdocs-tabs>
                                    <dl style="display: none">
                                       
                                       <dt>Python</dt>
                                       <dd tab-id="python">
                                          
                                          <p>An example of a pre-provisioning hook Lambda in Python.</p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import json

def pre_provisioning_hook(event, context):
    print(event)

    return <span>{</span>
        'allowProvisioning': True,
        'parameterOverrides': <span>{</span>
            'DeviceLocation': 'Seattle'
        }
    }</code></pre>
                                          </dd>
                                       
                                       <dt>Java</dt>
                                       <dd tab-id="java">
                                          
                                          <p>An example of a pre-provisioning hook Lambda in Java.</p>
                                          
                                          <p>Handler class:</p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="java ">package example;

import java.util.Map;
import java.util.HashMap;
import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;

public class PreProvisioningHook implements RequestHandler&lt;PreProvisioningHookRequest, PreProvisioningHookResponse&gt; <span>{</span>

    public PreProvisioningHookResponse handleRequest(PreProvisioningHookRequest object, Context context) <span>{</span>
        Map&lt;String, String&gt; parameterOverrides = new HashMap&lt;String, String&gt;();
        parameterOverrides.put("DeviceLocation", "Seattle");

        PreProvisioningHookResponse response = PreProvisioningHookResponse.builder()
                .allowProvisioning(true)
                .parameterOverrides(parameterOverrides)
                .build();

        return response;
    }

}</code></pre>
                                          <p>Request class:</p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="java ">package example;

import java.util.Map;
import lombok.Builder;
import lombok.Data;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class PreProvisioningHookRequest <span>{</span>
    private String claimCertificateId;
    private String certificateId;
    private String certificatePem;
    private String templateArn;
    private String clientId;
    private Map&lt;String, String&gt; parameters;
}</code></pre>
                                          <p>Response class:</p>
                                          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="java ">package example;

import java.util.Map;
import lombok.Builder;
import lombok.Data;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;


@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class PreProvisioningHookResponse <span>{</span>
    private boolean allowProvisioning;
    private Map&lt;String, String&gt; parameterOverrides;
}</code></pre>
                                          </dd>
                                       
                                    </dl>
                                 </awsdocs-tabs>
                                 
                                 <awsdocs-copyright class="copyright-print"></awsdocs-copyright>
                                 <awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback>
                              </div>
                              <noscript>
                                 <div>
                                    <div>
                                       <div>
                                          <div id="js_error_message">
                                             <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your
                                                   browser.</strong></p>
                                             <p>To use the Amazon Web Services Documentation, Javascript must be
                                                enabled. Please refer to your browser's Help pages for instructions.
                                             </p>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </noscript>
                              <div id="main-col-footer" class="awsui-util-font-size-0">
                                 <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                                 <div class="prev-next">
                                    <div id="previous" class="prev-link" accesskey="p" href="./provision-template.html">Provisioning templates</div>
                                    <div id="next" class="next-link" accesskey="n" href="./fleet-provision-api.html">Device provisioning MQTT API</div>
                                 </div>
                              </div>
                              <awsdocs-page-utilities></awsdocs-page-utilities>
                           </div>
                           <div id="quick-feedback-yes" style="display: none;">
                              <div class="title">Did this page help you? - Yes</div>
                              <div class="content">
                                 <p>Thanks for letting us know we're doing a good
                                    job!
                                 </p>
                                 <p>If you've got a moment, please tell us what we did right
                                    so we can do more of it.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/pre-provisioning-hook.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                           <div id="quick-feedback-no" style="display: none;">
                              <div class="title">Did this page help you? - No</div>
                              <div class="content">
                                 <p>Thanks for letting us know this page needs work. We're
                                    sorry we let you down.
                                 </p>
                                 <p>If you've got a moment, please tell us how we can make
                                    the documentation better.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/pre-provisioning-hook.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                        </div>
                     </body>
                  </div>
               </awsdocs-view>
               <div class="page-loading-indicator" id="page-loading-indicator">
                  <awsui-spinner size="large"></awsui-spinner>
               </div>
            </div>
            <div id="tools-panel" dom-region="tools">
               <awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel>
            </div>
         </awsui-app-layout>
         <awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner>
         <!--
                SiteCatalyst code version: H.25.2.
                Copyright 1996-2012 Adobe, Inc. All Rights Reserved
                More info available at http://www.omniture.com
            --><script language="JavaScript" type="text/javascript">
var awsdocs = awsdocs || {};
awsdocs.prop66 = 'AWS IoT Core';
awsdocs.prop65 =  'Developer Guide';
            </script><script src="https://a0.awsstatic.com/s_code/js/3.0/awshome_s_code.js" language="JavaScript" type="text/javascript"></script>
         <!--/DO NOT REMOVE/-->
         <!--End SiteCatalyst code version: H.25.2.--></div>
   </body>
</html>