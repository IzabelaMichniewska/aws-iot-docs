<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="AWSDocsDocPageApp">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Setting up your Raspberry Pi and moisture sensor - AWS IoT Core</title>
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <meta name="assets_root" content="assets" />
      <meta name="target_state" content="iot-moisture-raspi-setup" />
      <meta name="default_state" content="iot-moisture-raspi-setup" />
      <link rel="icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" />
      <link rel="canonical" href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-moisture-raspi-setup.html" />
      <meta name="description" content="Green: I2C SCL White: I2C SDA Red: power (3.5 V) Black: ground On Welcome to Raspberry Pi , choose Next . Choose your country, language, timezone, and keyboard layout. Choose Next . Enter a password for your Raspberry Pi, and then choose" />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="AWS IoT Core" />
      <meta name="guide" content="Developer Guide" />
      <meta name="locales" content="de_de:Deutsch/en_us:English/es_es:Español/fr_fr:Français/it_it:Italiano/ja_jp:日本語/ko_kr:한국어/pt_br:Português/zh_cn:中文 (简体)/zh_tw:中文 (繁體)" />
      <meta name="abstract" content="AWS IoT provides secure, bi-directional communication between Internet-connected devices such as sensors, actuators, embedded micro-controllers, or smart appliances and the AWS Cloud. This enables you to collect telemetry data from multiple devices, and store and analyze the data. You can also create applications that enable your users to control these devices from their phones or tablets." />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <meta name="feedback-item" content="IoT Docs" />
      <meta name="this_doc_product" content="AWS IoT Core" />
      <meta name="this_doc_guide" content="Developer Guide" />
      <link href="assets/css/vendor4.css" rel="stylesheet" />
      <link href="assets/css/awsdocs-common.css" rel="stylesheet" /><script type="text/javascript" src="assets/js/vendor3.js" defer=""></script><script type="text/javascript" src="assets/js/vendor4.js" defer=""></script><script type="text/javascript" src="assets/js/vendor1.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-common.js" defer=""></script><script type="text/javascript" src="assets/js/awsdocs-doc-app.js" defer=""></script></head>
   <body class="awsdocs awsui">
      <div class="awsdocs-container">
         <awsdocs-header></awsdocs-header>
         <awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)">
            <div id="guide-toc" dom-region="navigation">
               <awsdocs-toc></awsdocs-toc>
            </div>
            <div id="main-column" dom-region="content" tabindex="-1">
               <awsdocs-view class="awsdocs-view">
                  <div id="awsdocs-content">
                     <head>
                        <title>Setting up your Raspberry Pi and moisture sensor - AWS IoT Core</title>
                        <meta name="pdf" content="iot-dg.pdf#iot-moisture-raspi-setup" />
                        <meta name="kindle" content="https://www.amazon.com/dp/B07JBRCWWZ" />
                        <meta name="github" content="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/iot-moisture-raspi-setup.md" />
                        <meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=210" />
                        <meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT%20Docs&amp;topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/iot-moisture-raspi-setup.html" />
                        <meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/iot-moisture-raspi-setup.html" />
                        <meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/iot/latest/developerguide/iot-moisture-raspi-setup.html" />
                        <meta name="keywords" content="AWS IoT,IoT,Internet of Things" />
                     </head>
                     <body>
                        <div id="main">
                           <div style="display: none"><a href="iot-dg.pdf#iot-moisture-raspi-setup" target="_blank" rel="noopener noreferrer" title="Open PDF"></a><a target="_blank" rel="noopener noreferrer" href="https://www.amazon.com/dp/B07JBRCWWZ" title="Open Kindle"></a><a href="https://github.com/awsdocs/aws-iot-docs/tree/master/developerguide/iot-moisture-raspi-setup.md" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub"></a></div>
                           <div id="breadcrumbs" class="breadcrumb"><a href="http://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/iot/index.html">AWS IoT Core</a><a href="what-is-aws-iot.html">Developer Guide</a></div>
                           <div id="main-content" class="awsui-util-container">
                              <div id="main-col-body">
                                 <awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner>
                                 <h1 class="topictitle" id="iot-moisture-raspi-setup">Setting up your Raspberry Pi and moisture
                                    sensor
                                 </h1>
                                 <div class="awsdocs-page-header-container">
                                    <awsdocs-page-header></awsdocs-page-header>
                                    <awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector>
                                 </div>
                                 <p></p>
                                 <p>Insert your micro SD card into the Raspberry Pi, connect your monitor, keyboard,
                                    mouse, and, if you're not using Wi-Fi, Ethernet cable. Do not connect the power cable
                                    yet.
                                 </p>
                                 <p>Connect the JST jumper cable to the moisture sensor. The other side of the jumper
                                    has
                                    four wires:
                                 </p>
                                 <div class="itemizedlist">
                                     
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p>Green: I2C SCL</p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>White: I2C SDA</p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>Red: power (3.5 V)</p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>Black: ground</p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                 <p>Hold the Raspberry Pi with the Ethernet jack on the right. In this orientation, there
                                    are two rows of GPIO pins at the top. Connect the wires from the moisture sensor to
                                    the
                                    bottom row of pins in the following order. Starting at the left-most pin, connect
                                    red
                                    (power), white (SDA), and green (SCL). Skip one pin, and then connect the black (ground)
                                    wire. For more information, see <a href="https://learn.adafruit.com/adafruit-stemma-soil-sensor-i2c-capacitive-moisture-sensor/python-circuitpython-test" rel="noopener noreferrer" target="_blank"><span>Python Computer Wiring</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                 </p>
                                 <p>Attach the power cable to the Raspberry Pi and plug the other end into a wall socket
                                    to turn it on.
                                 </p>
                                 <div class="procedure">
                                    <p class="title"><b>Configure your Raspberry Pi</b></p>
                                    <ol>
                                       <li>
                                          
                                          <p>On <b>Welcome to Raspberry Pi</b>, choose
                                             <b>Next</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Choose your country, language, timezone, and keyboard layout. Choose
                                             <b>Next</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Enter a password for your Raspberry Pi, and
                                             then
                                             choose <b>Next</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Choose your Wi-Fi network, and then choose <b>Next</b>. If you
                                             aren't using a Wi-Fi network, choose <b>Skip</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Choose <b>Next</b> to check for software updates. When the
                                             updates are complete, choose <b>Restart</b> to restart your
                                             Raspberry Pi.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 <p>After your Raspberry Pi starts up, enable the I2C interface.</p>
                                 <div class="procedure">
                                    <ol>
                                       <li>
                                          
                                          <p>In the upper left corner of the Raspbian desktop, click the Raspberry icon,
                                             choose <b>Preferences</b>, and then choose <b>Raspberry Pi
                                                Configuration</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>On the <b>Interfaces</b> tab, for <b>I2C</b>,
                                             choose <b>Enable</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Choose <b>OK</b>.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 <p>The libraries for the Adafruit STEMMA moisture sensor are written for CircuitPython.
                                    To run them on a Raspberry Pi, you need to install the latest version of Python
                                    3.
                                 </p>
                                 <div class="procedure">
                                    <ol>
                                       <li>
                                          
                                          <p>Run the following commands from a command prompt to update your Raspberry Pi
                                             software:
                                          </p>
                                          
                                          <p><code class="code">sudo apt-get update</code></p>
                                          
                                          <p><code class="code">sudo apt-get upgrade</code></p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Run the following command to update your Python 3 installation:</p>
                                          
                                          <p><code class="code">sudo pip3 install --upgrade setuptools</code></p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Run the following command to install the Raspberry Pi GPIO libraries:</p>
                                          
                                          <p><code class="code">pip3 install RPI.GPIO</code></p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Run the following command to install the Adafruit Blinka libraries:</p>
                                          
                                          <p><code class="code">pip3 install adafruit-blinka</code></p>
                                          
                                          <p>For more information, see <a href="https://learn.adafruit.com/circuitpython-on-raspberrypi-linux/installing-circuitpython-on-raspberry-pi" rel="noopener noreferrer" target="_blank"><span>Installing CircuitPython Libraries on Raspberry Pi</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Run the following command to install the Adafruit Seesaw libraries:</p>
                                          
                                          <p><code class="code">sudo pip3 install adafruit-circuitpython-seesaw</code></p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Run the following command to install the AWS IoT Device SDK for Python:</p>
                                          
                                          <p><code class="code">pip3 install AWSIoTPythonSDK</code></p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 <p>Your Raspberry Pi now has all of the required libraries. Create a file called
                                    <code class="userinput">moistureSensor.py</code> and copy the following Python code into the
                                    file:
                                 </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">
from adafruit_seesaw.seesaw import Seesaw
from AWSIoTPythonSDK.MQTTLib import AWSIoTMQTTShadowClient
from board import SCL, SDA

import logging
import time
import json
import argparse
import busio

# Shadow JSON schema:
#
# <span>{</span>
#   "state": <span>{</span>
#       "desired":<span>{</span>
#           "moisture":&lt;INT VALUE&gt;,
#           "temp":&lt;INT VALUE&gt;            
#       }
#   }
# }

# Function called when a shadow is updated
def customShadowCallback_Update(payload, responseStatus, token):

    # Display status and data from update request
    if responseStatus == "timeout":
        print("Update request " + token + " time out!")

    if responseStatus == "accepted":
        payloadDict = json.loads(payload)
        print("~~~~~~~~~~~~~~~~~~~~~~~")
        print("Update request with token: " + token + " accepted!")
        print("moisture: " + str(payloadDict["state"]["reported"]["moisture"]))
        print("temperature: " + str(payloadDict["state"]["reported"]["temp"]))
        print("~~~~~~~~~~~~~~~~~~~~~~~\n\n")

    if responseStatus == "rejected":
        print("Update request " + token + " rejected!")

# Function called when a shadow is deleted
def customShadowCallback_Delete(payload, responseStatus, token):

     # Display status and data from delete request
    if responseStatus == "timeout":
        print("Delete request " + token + " time out!")

    if responseStatus == "accepted":
        print("~~~~~~~~~~~~~~~~~~~~~~~")
        print("Delete request with token: " + token + " accepted!")
        print("~~~~~~~~~~~~~~~~~~~~~~~\n\n")

    if responseStatus == "rejected":
        print("Delete request " + token + " rejected!")


# Read in command-line parameters
def parseArgs():

    parser = argparse.ArgumentParser()
    parser.add_argument("-e", "--endpoint", action="store", required=True, dest="host", help="Your device data endpoint")
    parser.add_argument("-r", "--rootCA", action="store", required=True, dest="rootCAPath", help="Root CA file path")
    parser.add_argument("-c", "--cert", action="store", dest="certificatePath", help="Certificate file path")
    parser.add_argument("-k", "--key", action="store", dest="privateKeyPath", help="Private key file path")
    parser.add_argument("-p", "--port", action="store", dest="port", type=int, help="Port number override")
    parser.add_argument("-n", "--thingName", action="store", dest="thingName", default="Bot", help="Targeted thing name")
    parser.add_argument("-id", "--clientId", action="store", dest="clientId", default="basicShadowUpdater", help="Targeted client id")

    args = parser.parse_args()
    return args


# Configure logging
# AWSIoTMQTTShadowClient writes data to the log
def configureLogging():

    logger = logging.getLogger("AWSIoTPythonSDK.core")
    logger.setLevel(logging.DEBUG)
    streamHandler = logging.StreamHandler()
    formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    streamHandler.setFormatter(formatter)
    logger.addHandler(streamHandler)


# Parse command line arguments
args = parseArgs()

if not args.certificatePath or not args.privateKeyPath:
    parser.error("Missing credentials for authentication.")
    exit(2)

# If no --port argument is passed, default to 8883
if not args.port: 
    args.port = 8883


# Init AWSIoTMQTTShadowClient
myAWSIoTMQTTShadowClient = None
myAWSIoTMQTTShadowClient = AWSIoTMQTTShadowClient(args.clientId)
myAWSIoTMQTTShadowClient.configureEndpoint(args.host, args.port)
myAWSIoTMQTTShadowClient.configureCredentials(args.rootCAPath, args.privateKeyPath, args.certificatePath)

# AWSIoTMQTTShadowClient connection configuration
myAWSIoTMQTTShadowClient.configureAutoReconnectBackoffTime(1, 32, 20)
myAWSIoTMQTTShadowClient.configureConnectDisconnectTimeout(10) # 10 sec
myAWSIoTMQTTShadowClient.configureMQTTOperationTimeout(5) # 5 sec

# Initialize Raspberry Pi's I2C interface
i2c_bus = busio.I2C(SCL, SDA)

# Intialize SeeSaw, Adafruit's Circuit Python library
ss = Seesaw(i2c_bus, addr=0x36)

# Connect to AWS IoT
myAWSIoTMQTTShadowClient.connect()

# Create a device shadow handler, use this to update and delete shadow document
deviceShadowHandler = myAWSIoTMQTTShadowClient.createShadowHandlerWithName(args.thingName, True)

# Delete current shadow JSON doc
deviceShadowHandler.shadowDelete(customShadowCallback_Delete, 5)

# Read data from moisture sensor and update shadow
while True:

    # read moisture level through capacitive touch pad
    moistureLevel = ss.moisture_read()

    # read temperature from the temperature sensor
    temp = ss.get_temp()

    # Display moisture and temp readings
    print("Moisture Level: <span>{</span>}".format(moistureLevel))
    print("Temperature: <span>{</span>}".format(temp))
    
    # Create message payload
    payload = <span>{</span>"state":<span>{</span>"reported":<span>{</span>"moisture":str(moistureLevel),"temp":str(temp)}}}

    # Update shadow
    deviceShadowHandler.shadowUpdate(json.dumps(payload), customShadowCallback_Update, 5)
    time.sleep(1)</code></pre><p>Save the file to a place you can find it. Run <code class="code">moistureSensor.py</code> from the
                                    command line with the following parameters:
                                 </p>
                                 <div class="variablelist">
                                     
                                     
                                     
                                     
                                     
                                     
                                    
                                    <dl>
                                       
                                       <dt><span class="term">endpoint</span></dt>
                                       
                                       <dd>
                                          
                                          <p>Your custom AWS IoT endpoint. For more information, see <a href="./device-shadow-rest-api.html">Device Shadow REST API</a>.
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term">rootCA</span></dt>
                                       
                                       <dd>
                                          
                                          <p>The full path the your AWS IoT root CA certificate.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term">cert</span></dt>
                                       
                                       <dd>
                                          
                                          <p>The full path to your AWS IoT device certificate.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term">key</span></dt>
                                       
                                       <dd>
                                          
                                          <p>The full path to your AWS IoT device certificate private key.</p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term">thingName</span></dt>
                                       
                                       <dd>
                                          
                                          <p>Your thing name (in this case, <code class="code">RaspberryPi</code>).
                                          </p>
                                          
                                       </dd>
                                        
                                       
                                       <dt><span class="term">clientId</span></dt>
                                       
                                       <dd>
                                          
                                          <p>The MQTT client ID. Use <code class="code">RaspberryPi</code>.
                                          </p>
                                          
                                       </dd>
                                       
                                    </dl>
                                 </div>
                                 <p>The command line should look like this:</p>
                                 <p><code class="code">python3 moistureSensor.py --endpoint <code class="replaceable">your-endpoint</code> --rootCA ~/certs/AmazonRootCA1.pem
                                       --cert ~/certs/raspberrypi-certificate.pem.crt --key ~/certs/raspberrypi-private.pem.key
                                       --thingName
                                       RaspberryPi --clientId RaspberryPi</code></p>
                                 <p>Try touching the sensor, putting it in a planter, or putting it in a glass of water
                                    to
                                    see how the sensor responds to various levels of moisture. If needed, you can change
                                    the
                                    threshold value in the <code class="code">MoistureSensorRule</code>. When the moisture sensor reading
                                    goes below the value specified in your rule's SQL query statement, AWS IoT publishes
                                    a
                                    message to the Amazon SNS topic. You should receive an email message that contains
                                    the
                                    moisture and temperature data.
                                 </p>
                                 <p>After you have verified receipt of email messages from Amazon SNS, press
                                    <b>CTRL+C</b> to stop the Python program. It is unlikely the Python
                                    program will send enough messages to incur charges, but it is a best practice to stop
                                    the program when you are done.
                                 </p>
                                 <awsdocs-copyright class="copyright-print"></awsdocs-copyright>
                                 <awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback>
                              </div>
                              <noscript>
                                 <div>
                                    <div>
                                       <div>
                                          <div id="js_error_message">
                                             <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your
                                                   browser.</strong></p>
                                             <p>To use the Amazon Web Services Documentation, Javascript must be
                                                enabled. Please refer to your browser's Help pages for instructions.
                                             </p>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </noscript>
                              <div id="main-col-footer" class="awsui-util-font-size-0">
                                 <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                                 <div class="prev-next">
                                    <div id="previous" class="prev-link" accesskey="p" href="./iot-moisture-create-rule.html">Create an AWS IoT rule to send an
                                       email
                                    </div>
                                    <div id="next" class="next-link" accesskey="n" href="./iot-thing-management.html">Managing devices with AWS IoT</div>
                                 </div>
                              </div>
                              <awsdocs-page-utilities></awsdocs-page-utilities>
                           </div>
                           <div id="quick-feedback-yes" style="display: none;">
                              <div class="title">Did this page help you? - Yes</div>
                              <div class="content">
                                 <p>Thanks for letting us know we're doing a good
                                    job!
                                 </p>
                                 <p>If you've got a moment, please tell us what we did right
                                    so we can do more of it.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/iot-moisture-raspi-setup.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                           <div id="quick-feedback-no" style="display: none;">
                              <div class="title">Did this page help you? - No</div>
                              <div class="content">
                                 <p>Thanks for letting us know this page needs work. We're
                                    sorry we let you down.
                                 </p>
                                 <p>If you've got a moment, please tell us how we can make
                                    the documentation better.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IoT Docs&amp;topic_url=https://docs.aws.amazon.com/en_us/iot/latest/developerguide/iot-moisture-raspi-setup.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                        </div>
                     </body>
                  </div>
               </awsdocs-view>
               <div class="page-loading-indicator" id="page-loading-indicator">
                  <awsui-spinner size="large"></awsui-spinner>
               </div>
            </div>
            <div id="tools-panel" dom-region="tools">
               <awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel>
            </div>
         </awsui-app-layout>
         <awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner>
         <!--
                SiteCatalyst code version: H.25.2.
                Copyright 1996-2012 Adobe, Inc. All Rights Reserved
                More info available at http://www.omniture.com
            --><script language="JavaScript" type="text/javascript">
var awsdocs = awsdocs || {};
awsdocs.prop66 = 'AWS IoT Core';
awsdocs.prop65 =  'Developer Guide';
            </script><script src="https://a0.awsstatic.com/s_code/js/3.0/awshome_s_code.js" language="JavaScript" type="text/javascript"></script>
         <!--/DO NOT REMOVE/-->
         <!--End SiteCatalyst code version: H.25.2.--></div>
   </body>
</html>